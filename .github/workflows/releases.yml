name: Dev Incremental Release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*.*"

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ONRAMPER_API_KEY: ${{ secrets.ONRAMPER_API_KEY }}
  ULTRALIGHT_RESOURCES_DIR: ./ultralight-sdk/resources/
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always
  CARGO_PROFILE_RELEASE_LTO: true
  CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 1

jobs:
  compile-and-package:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
          - os: windows-latest
          - os: macos-latest

    name: upload-binaries
    if: github.repository == 'coincubetech/liana'
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false

      - uses: taiki-e/create-gh-release-action@v1
        with:
          title: ${{ github.ref_name }}
          branch: master

      # Install necessary tools
      - uses: milliewalky/setup-7-zip@v2
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-wix,apple-codesign

      # For Linux upload binary and libraries in a compressed tarball
      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y libudev-dev pkg-config

      - name: Download ultralight-sdk
        if: matrix.os == 'ubuntu-latest'
        run: |
          curl -L -O https://github.com/coincubetech/liana/releases/download/v0.0.1/ultralight-sdk-latest-linux-x64.7z
          7z x ultralight-sdk-latest-linux-x64.7z -oultralight-sdk -y
          mv ultralight-sdk/bin lib

      - uses: taiki-e/upload-rust-binary-action@v1
        if: matrix.os == 'ubuntu-latest'
        with:
          package: liana-gui
          bin: coincube-vault
          archive: coincube-vault-$tag-$target
          target: x86_64-unknown-linux-gnu
          include: LICENCE,README.md,lib
          profile: app-release
          locked: true

      # Generate icons for macOS and Windows
      - name: Generate Icons for Installers
        if: matrix.os != 'ubuntu-latest'
        run: |
          pip install pillow icnsutil
          python ./contrib/release/macos/icns-creator.py

      # For Windows upload an installer
      - name: Download ultralight-sdk
        if: matrix.os == 'windows-latest'
        run: |
          curl -L -O https://github.com/coincubetech/liana/releases/download/v0.0.1/ultralight-sdk-latest-win-x64.7z
          7z x ultralight-sdk-latest-win-x64.7z -oultralight-sdk -y

      - name: Package and release .msi installer for Windows
        if: matrix.os == 'windows-latest'
        run: |
          choco install wixtoolset --version=3.14.1 --yes
          cargo wix --package liana-gui --profile app-release --output "target\wix\Coincube Vault.msi" --include ./contrib/release/wix/main.wxs --nocapture -v

      - name: Upload .msi to release
        if: matrix.os == 'windows-latest'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "target/wix/Coincube Vault.msi"
          tag: ${{ github.ref }}
          overwrite: true
          body: "Installers for Windows, macOS and Linux"

      # For macOS upload a signed and notarized dmg
      - name: Compile Project for macOS x86 and arm64
        if: matrix.os == 'macos-latest'
        run: |
          cargo build --package liana-gui --profile app-release
          cp target/app-release/coincube-vault Vault

      - name: Download ultralight-sdk
        if: matrix.os == 'macos-latest'
        run: |
          curl -L -O https://github.com/coincubetech/liana/releases/download/v0.0.1/ultralight-sdk-latest-mac-arm64.7z
          7z x ultralight-sdk-latest-mac-arm64.7z -oultralight-sdk -y

      - name: Copy Executable, Icons and Extra Metadata into .app folder
        if: matrix.os == 'macos-latest'
        run: |
          unzip ./contrib/release/macos/Vault.app.zip
          sed -i '' "s/VERSION_PLACEHOLDER/${{ github.ref_name }}/g" ./Vault.app/Contents/Info.plist
          mv Vault ./Vault.app/Contents/MacOS/Vault
          cp -r ultralight-sdk/bin ./Vault.app/Contents/Frameworks
          mv ./contrib/release/macos/Vault.icns ./Vault.app/Contents/Resources/Vault.icns

      - name: CodeSign macOS App Bundle
        if: matrix.os == 'macos-latest'
        env:
          P12_BASE64: ${{ secrets.CERTIFICATE_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.CERTIFICATE_P12_PASSWORD }}
        run: |
          echo "$P12_BASE64" | base64 -d > signing_certificate.p12
          echo "$P12_PASSWORD" > signing_certificate.password
          rcodesign sign --p12-file signing_certificate.p12 --p12-password-file signing_certificate.password --code-signature-flags runtime Vault.app
          rm signing_certificate.p12 signing_certificate.password

      - name: Notarize and Staple macOS App bundle
        if: matrix.os == 'macos-latest'
        run: |
          base64 -D <<< "${{ secrets.APPSTORECONNECT_KEY_JSON }}" > appstoreconnect_key.json
          rcodesign notary-submit --api-key-path appstoreconnect_key.json --max-wait-seconds 1800 --staple Vault.app
          spctl --verbose=4 --assess --type execute Vault.app
          rm appstoreconnect_key.json
          ditto -c -k --sequesterRsrc --keepParent Vault.app Vault.app.zip

      - name: Upload .app.zip file as Release Artefact
        if: matrix.os == 'macos-latest'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "Vault.app.zip"
          tag: ${{ github.ref }}
          overwrite: true
          body: "macOS App Bundle (arm64)"
